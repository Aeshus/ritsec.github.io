---
const {
  class: className,
  loop = false,
  autoplay = false,
  autoplayDelay = 4000,
  autoscroll = false,
  autoscrollSpeed = 1,
  dots = false,
  ...rest
} = Astro.props;
---

<div
  class:list={["embla", className]}
  data-loop={loop ? 'true' : null}
  data-autoplay={autoplay ? 'true' : null}
  data-autoplay-delay={autoplayDelay}
  data-autoscroll={autoscroll ? 'true' : null}
  data-autoscroll-speed={autoscrollSpeed}
  data-dots={dots ? 'true' : null}
  {...rest}
>
  <div class="viewport">
    <div class="container">
      <slot />
    </div>
  </div>
  {dots && <div class="dots"></div>}
</div>

<style>
  .embla {
    position: relative;
    overflow: hidden;
  }

  .viewport {
    overflow: hidden;
  }

  .container {
    display: flex;
  }

  .container > :global(*) {
    flex: 0 0 100%;
    min-width: 0;
    position: relative;
  }

  .dots {
    position: absolute;
    bottom: 20px; 
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .embla:hover .dots {
    opacity: 1;
  }

  .embla__dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    background: rgba(255, 255, 255, 0.4);
    cursor: pointer;
    transition: all 0.3s;
    -webkit-appearance: none;
    appearance: none;
    padding: 0;
    margin: 0;
  }

  .embla__dot.is-selected {
    background: #fff;
  }
</style>

<script>
  import EmblaCarousel from 'embla-carousel';
  import Autoplay from 'embla-carousel-autoplay';
  import Autoscroll from 'embla-carousel-autoscroll';

  document.addEventListener('DOMContentLoaded', () => {
    const emblaNodes = document.querySelectorAll('.embla');

    emblaNodes.forEach((emblaNode) => {
      const viewportNode = emblaNode.querySelector(
        '.viewport'
      );
      const dotsNode = emblaNode.querySelector('.dots');
      const containerNode = emblaNode.querySelector('.container');

      if (!viewportNode || !containerNode) return;

      containerNode.style.touchAction = 'pan-y';
      containerNode.style.userSelect = 'none';

      const isAutoscroll = emblaNode.dataset.autoscroll === 'true';

      const options = {
        loop: emblaNode.dataset.loop === 'true',
        dragFree: isAutoscroll, 
      };

      const plugins = [];
      if (emblaNode.dataset.autoplay === 'true') {
        plugins.push(
          Autoplay({
            delay: parseInt(emblaNode.dataset.autoplayDelay || '4000', 10),
            stopOnInteraction: false,
          })
        );
      }
      if (isAutoscroll) {
        plugins.push(
          Autoscroll({
            speed: parseFloat(emblaNode.dataset.autoscrollSpeed || '1'),
            stopOnInteraction: false,
          })
        );
      }

      const emblaApi = EmblaCarousel(viewportNode, options, plugins);

      if (dotsNode) {
        let dots = []; 

        const createDots = () => {
          dotsNode.innerHTML = '';
          const fragment = document.createDocumentFragment();
          emblaApi.scrollSnapList().forEach((_, index) => {
            const button = document.createElement('button');
            button.classList.add('embla__dot');
            button.type = 'button';
            button.addEventListener('click', () => emblaApi.scrollTo(index));
            fragment.appendChild(button);
          });
          dotsNode.appendChild(fragment);
          dots = Array.from(dotsNode.querySelectorAll('.embla__dot'));
        };

        const selectDot = () => {
          if (dots.length === 0) return;
          const selectedIndex = emblaApi.selectedScrollSnap();
          dots.forEach((dot, index) => {
            dot.classList.toggle('is-selected', index === selectedIndex);
          });
        };

        emblaApi.on('select', selectDot);
        emblaApi.on('reInit', () => {
          createDots();
          selectDot();
        });
        emblaApi.on('init', ();
        
        createDots();
        selectDot();
      }
    });
  });
</script>

