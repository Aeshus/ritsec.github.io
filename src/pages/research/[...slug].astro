---
import { getCollection } from "astro:content";

import BaseLayout from "@/layouts/BaseLayout.astro";
import Hero from "@/components/Hero.astro";

import { formatDate, getEmbedUrl } from "@/utils.js";

export async function getStaticPaths() {
    const groupEntries = await getCollection("research");
    return groupEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const videoUrl = getEmbedUrl(entry.data.video);
const slideshowUrl = getEmbedUrl(entry.data.slideshow);
---

<BaseLayout title={entry.data.title} description={entry.data.summary}>
    <Hero
        badge={formatDate(entry.data.date) +
            (entry.data.group ? " â€¢ " + entry.data.group.id.toUpperCase() : "")}
    >
        <Fragment slot="badge"> </Fragment>

        <Fragment slot="title">
            {entry.data.title}
        </Fragment>

        <div>
            {
                entry.data.authors.length > 0 ? (
                    <span>
                        By: {entry.data.authors.map((a) => a.name).join(", ")}
                    </span>
                ) : (
                    <span>RITSEC</span>
                )
            }
        </div>

        <div class="summary">
            {entry.data.summary}
        </div>
    </Hero>

    {
        (videoUrl || slideshowUrl) && (
            <section class="media-container copy">
                {videoUrl && (
                    <>
                        <h2>Video</h2>
                        <div class="video-container">
                            <iframe
                                src={videoUrl}
                                title="Video player"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen
                            />
                        </div>
                    </>
                )}
                {(slideshowUrl || videoUrl) && (
                    <div class="list copy">
                        {videoUrl && (
                            <a href={videoUrl} class="link-button primary">
                                Video
                            </a>
                        )}
                        {slideshowUrl && (
                            <a href={slideshowUrl} class="link-button primary">
                                Slideshow
                            </a>
                        )}
                    </div>
                )}
            </section>
        )
    }

    <Content />
</BaseLayout>

<style is:global>
    main > section > p {
        max-width: 100%;
    }

    main > section * {
        text-align: start;
    }

    .list.copy {
        justify-content: start;
    }

    :root {
        --page-width: 60rem;
    }
</style>

<style>
    section {
        --page-width: 90ch;
        --page-padding: max(1rem, (100% - var(--page-width)) / 2);
    }

    .summary {
        margin-top: var(--padding);
        font-style: italic;
    }

    .media-container {
        display: flex;
        flex-direction: column;
    }

    .video-container {
        position: relative;
        aspect-ratio: 16/9;
        overflow: hidden;
        border-radius: 8px;
        border: var(--border);
    }

    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
</style>
